# Azure DevOps Application Pipeline
# FinRisk Platform - Applicant Validator Build & Deploy Only
#
# This pipeline handles application CI/CD:
# - Build, test, lint Docker image
# - Deploy to Azure Container Apps
# - Assumes infrastructure already exists (use infra pipeline first)

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - app/**
      - pipelines/azure-pipelines-app.yml

pr:
  branches:
    include:
      - main
  paths:
    include:
      - app/**

variables:
  - group: finrisk-dev
  - name: azureSubscription
    value: 'azure-service-connection'
  - name: environmentName
    value: 'dev'
  - name: pythonVersion
    value: '3.13'
  - name: dockerRegistryServiceConnection
    value: 'acr-service-connection'
  - name: containerRegistry
    value: 'acrfinriskdev.azurecr.io'      # Matches Terraform: acr${project_name}${environment}
  - name: imageName
    value: 'applicant-validator'            # Domain service name (DDD)
  - name: imageTag
    value: '$(Build.BuildId)'
  - name: containerAppName
    value: 'ca-finrisk-dev'                 # Matches Terraform: ca-${project_name}-${environment}
  - name: resourceGroupName
    value: 'rg-finrisk-dev'                 # Matches Terraform: rg-${project_name}-${environment}

stages:
  # ========================================
  # STAGE 1: BUILD & TEST
  # ========================================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: Test
        pool: Default
        steps:
          - checkout: self
            fetchDepth: 0

          - script: |
              echo "##vso[task.prependpath]/opt/homebrew/opt/python@3.13/bin"
              echo "##vso[task.prependpath]/Users/tvl/.local/bin"
            displayName: 'Setup Python PATH'

          - script: |
              uv --version || (curl -LsSf https://astral.sh/uv/install.sh | sh)
            displayName: 'Verify uv'

          - script: |
              cd app && uv sync --extra dev
            displayName: 'Install Dependencies'

          - script: |
              cd app && uv run ruff check src/ --output-format=github
            displayName: 'Lint (Ruff)'
            continueOnError: true

          - script: |
              cd app && uv run mypy src/
            displayName: 'Type Check (mypy)'
            continueOnError: true

          - script: |
              cd app && uv run bandit -r src/ -c pyproject.toml
            displayName: 'Security Scan (Bandit)'
            continueOnError: true

          - script: |
              cd app && uv run pytest tests/unit/ \
                --junitxml=junit/test-results.xml \
                --cov=src --cov-report=xml --cov-report=html
            displayName: 'Run Unit Tests'

          - task: PublishTestResults@2
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-*.xml'

          - task: PublishCodeCoverageResults@2
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/app/coverage.xml'

      - job: BuildImage
        dependsOn: Test
        pool: Default
        steps:
          - checkout: self

          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: login
              containerRegistry: $(dockerRegistryServiceConnection)

          - script: |
              set -x  # Enable debug mode
              # Debug environment
              echo "=== Environment Debug ==="
              echo "PATH: $PATH"
              echo "Which docker: $(which docker)"
              docker --version || echo "ERROR: docker --version failed with exit code $?"

              # Use absolute path to OrbStack docker
              DOCKER_PATH="/Users/tvl/.orbstack/bin/docker"
              echo "=== Testing Docker Path ==="
              echo "Using Docker at: $DOCKER_PATH"
              if [ ! -f "$DOCKER_PATH" ]; then
                echo "ERROR: Docker not found at $DOCKER_PATH"
                exit 1
              fi
              $DOCKER_PATH --version || echo "ERROR: docker --version failed with exit code $?"
              $DOCKER_PATH buildx version || echo "ERROR: buildx version failed with exit code $?"

              # Setup buildx for cross-platform builds
              echo "=== Creating/Using Buildx Builder ==="
              $DOCKER_PATH buildx create --name mybuilder --use 2>&1 || {
                echo "Builder already exists, switching to it..."
                $DOCKER_PATH buildx use mybuilder || exit 1
              }

              echo "=== Inspecting Buildx Builder ==="
              $DOCKER_PATH buildx inspect --bootstrap || {
                echo "ERROR: buildx inspect failed with exit code $?"
                exit 1
              }

              echo "=== Buildx Setup Complete ==="
            displayName: 'Setup Docker Buildx'

          - script: |
              DOCKER_PATH="/Users/tvl/.orbstack/bin/docker"
              cd app
              $DOCKER_PATH buildx build \
                --platform linux/amd64 \
                --target production \
                -t $(containerRegistry)/$(imageName):$(imageTag) \
                -t $(containerRegistry)/$(imageName):latest \
                --push \
                .
            displayName: 'Build and Push Docker Image (AMD64)'

          - script: |
              # Install trivy on macOS
              if command -v brew &> /dev/null; then
                brew install trivy 2>/dev/null || true
                trivy image --severity HIGH,CRITICAL $(containerRegistry)/$(imageName):$(imageTag)
              fi
            displayName: 'Scan Image (Trivy)'
            continueOnError: true

  # ========================================
  # STAGE 2: DEPLOY
  # ========================================
  - stage: Deploy
    displayName: 'Deploy to Container Apps'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployContainerApp
        pool: Default
        environment: '$(environmentName)'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Update Container App'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az containerapp update \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroupName) \
                        --image $(containerRegistry)/$(imageName):$(imageTag) \
                        --output table

                - script: sleep 30
                  displayName: 'Wait for Deployment'

  # ========================================
  # STAGE 3: VERIFY
  # ========================================
  - stage: Verify
    displayName: 'Smoke Tests'
    dependsOn: Deploy
    jobs:
      - job: SmokeTests
        pool: Default
        steps:
          - task: AzureCLI@2
            displayName: 'Get App URL'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                APP_URL=$(az containerapp show \
                  --name $(containerAppName) \
                  --resource-group $(resourceGroupName) \
                  --query properties.configuration.ingress.fqdn \
                  --output tsv)
                echo "##vso[task.setvariable variable=appUrl]https://$APP_URL"

          - script: |
              for i in {1..10}; do
                STATUS=$(curl -s -o /dev/null -w "%{http_code}" $(appUrl)/health)
                if [ "$STATUS" = "200" ]; then
                  echo "Health check passed"
                  exit 0
                fi
                echo "Attempt $i: HTTP $STATUS - retrying..."
                sleep 10
              done
              exit 1
            displayName: 'Health Check'

          - script: |
              curl -sf $(appUrl)/docs > /dev/null && echo "Docs OK" || exit 1
              curl -sf $(appUrl)/ready > /dev/null && echo "Ready OK" || exit 1
            displayName: 'Endpoint Checks'
